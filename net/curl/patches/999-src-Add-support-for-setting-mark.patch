From fd3a53eaa98b2234dedb9c7a989f89d0fc54db7d Mon Sep 17 00:00:00 2001
From: Kristian Evensen <kristian.evensen@gmail.com>
Date: Wed, 8 Sep 2021 12:58:24 +0200
Subject: [PATCH] src: Add support for setting mark

---
 include/curl/curl.h |  3 +++
 lib/connect.c       | 11 +++++++++++
 lib/setopt.c        |  9 +++++++++
 lib/urldata.h       |  1 +
 src/tool_cfgable.h  |  1 +
 src/tool_getparam.c | 14 ++++++++++++--
 src/tool_operate.c  |  3 +++
 7 files changed, 40 insertions(+), 2 deletions(-)

diff --git a/include/curl/curl.h b/include/curl/curl.h
index 521c254e7..024fa5226 100644
--- a/include/curl/curl.h
+++ b/include/curl/curl.h
@@ -2105,6 +2105,9 @@ typedef enum {
      this option is used only if PROXY_SSL_VERIFYPEER is true */
   CURLOPT(CURLOPT_PROXY_CAINFO_BLOB, CURLOPTTYPE_BLOB, 310),
 
+  /* Set mark on packets */
+  CURLOPT(CURLOPT_SOCKET_MARK, CURLOPTTYPE_LONG, 309),
+
   CURLOPT_LASTENTRY /* the last unused */
 } CURLoption;
 
diff --git a/lib/connect.c b/lib/connect.c
index 11e6b888b..0be666e8b 100644
--- a/lib/connect.c
+++ b/lib/connect.c
@@ -1633,6 +1633,17 @@ CURLcode Curl_socket(struct Curl_easy *data,
   }
 #endif
 
+#ifdef SO_MARK
+  if(data->set.socket_mark) {
+    int optval = (int) data->set.socket_mark;
+    if(setsockopt(*sockfd, SOL_SOCKET, SO_MARK, (void *) &optval,
+       sizeof(optval))) {
+      close(*sockfd);
+      return CURLE_COULDNT_CONNECT;
+    }
+  }
+#endif
+
   return CURLE_OK;
 }
 
diff --git a/lib/setopt.c b/lib/setopt.c
index 076fe5f59..8b4d64d6f 100644
--- a/lib/setopt.c
+++ b/lib/setopt.c
@@ -3008,6 +3008,15 @@ CURLcode Curl_vsetopt(struct Curl_easy *data, CURLoption option, va_list param)
       return result;
     break;
 #endif
+#ifdef SO_MARK
+  case CURLOPT_SOCKET_MARK:
+    uarg = va_arg(param, unsigned long);
+#if SIZEOF_LONG > 4
+    if(uarg > UINT_MAX)
+      return CURLE_BAD_FUNCTION_ARGUMENT;
+#endif
+    data->set.socket_mark = (unsigned int)uarg;
+    break;
   default:
     /* unknown tag and its companion, just ignore: */
     result = CURLE_UNKNOWN_OPTION;
diff --git a/lib/urldata.h b/lib/urldata.h
index 1d9911208..a71cefa18 100644
--- a/lib/urldata.h
+++ b/lib/urldata.h
@@ -1772,6 +1772,7 @@ struct UserDefined {
                                                   before resolver start */
   void *resolver_start_client; /* pointer to pass to resolver start callback */
   long upkeep_interval_ms;      /* Time between calls for connection upkeep. */
+  long socket_mark;		/* Mark to set on all packets. */
   multidone_func fmultidone;
   struct Curl_easy *dohfor; /* this is a DoH request for that transfer */
   CURLU *uh; /* URL handle for the current parsed URL */
diff --git a/src/tool_cfgable.h b/src/tool_cfgable.h
index b00aacb76..4d373ea6d 100644
--- a/src/tool_cfgable.h
+++ b/src/tool_cfgable.h
@@ -286,6 +286,7 @@ struct OperationConfig {
                                      0 is valid. default: CURL_HET_DEFAULT. */
   bool haproxy_protocol;          /* whether to send HAProxy protocol v1 */
   bool disallow_username_in_url;  /* disallow usernames in URLs */
+  long socket_mark;               /* Assign mark to packet */
   char *aws_sigv4;
   struct GlobalConfig *global;
   struct OperationConfig *prev;
diff --git a/src/tool_getparam.c b/src/tool_getparam.c
index 641cca2e4..adb3e67b6 100644
--- a/src/tool_getparam.c
+++ b/src/tool_getparam.c
@@ -319,6 +319,7 @@ static const struct LongShort aliases[]= {
   {"R",  "remote-time",              ARG_BOOL},
   {"s",  "silent",                   ARG_BOOL},
   {"S",  "show-error",               ARG_BOOL},
+  {"Sm", "socket-mark",              ARG_STRING},
   {"t",  "telnet-option",            ARG_STRING},
   {"T",  "upload-file",              ARG_FILENAME},
   {"u",  "user",                     ARG_STRING},
@@ -2121,8 +2122,17 @@ ParameterError getparameter(const char *flag, /* f or -long-flag */
         global->showerror = (!toggle)?TRUE:FALSE; /* toggle off */
       break;
     case 'S':
-      /* show errors */
-      global->showerror = toggle?1:0; /* toggle on if used with -s */
+      switch (subletter) {
+      case '\0':
+        /* show errors */
+        global->showerror = toggle?1:0; /* toggle on if used with -s */
+        break;
+      case 'm':
+        err = str2num(&config->socket_mark, nextarg);
+        if(err)
+          return err;
+        break;
+      }
       break;
     case 't':
       /* Telnet options */
diff --git a/src/tool_operate.c b/src/tool_operate.c
index e6ca575bf..89b217137 100644
--- a/src/tool_operate.c
+++ b/src/tool_operate.c
@@ -2028,6 +2028,9 @@ static CURLcode single_transfer(struct GlobalConfig *global,
         if(config->hsts)
           my_setopt_str(curl, CURLOPT_HSTS, config->hsts);
 
+        if(config->socket_mark)
+          my_setopt(curl, CURLOPT_SOCKET_MARK, config->socket_mark);
+
         /* initialize retry vars for loop below */
         per->retry_sleep_default = (config->retry_delay) ?
           config->retry_delay*1000L : RETRY_SLEEP_DEFAULT; /* ms */
-- 
2.25.1

